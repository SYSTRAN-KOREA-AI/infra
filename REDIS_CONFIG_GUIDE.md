# Redis 구성(Configuration) 가이드

이 문서는 우리 프로젝트의 Redis가 왜 현재와 같이 구성되었는지 설명하기 위한 가이드입니다. Redis 설정에 익숙하지 않은 분들을 위해 각 옵션의 의미와 선택 이유를 쉽게 풀어서 작성했습니다.

## 1. 아키텍처 목표: 안정적이고 자동 복구되는 Redis

우리 프로젝트의 Redis는 단순히 데이터를 저장하는 것을 넘어, **안정적으로 운영**되고 **장애가 발생했을 때 스스로 복구**하는 것을 목표로 합니다. 이를 위해 **마스터-레플리카(Master-Replica) 복제**와 **센티널(Sentinel)을 이용한 고가용성(High-Availability)** 아키텍처를 사용합니다.

- **마스터 (Master)**: 모든 데이터의 쓰기(Write) 작업을 처리하는 원본 서버입니다. 오직 하나만 존재합니다.
- **레플리카 (Replica)**: 마스터의 데이터를 실시간으로 복제하는 사본 서버입니다. 읽기(Read) 작업을 분산 처리하거나, 마스터에 장애가 발생했을 때 새로운 마스터가 되는 역할을 합니다.
- **센티널 (Sentinel)**: 마스터 서버가 정상적으로 동작하는지 24시간 감시하는 '감시탑'입니다. 마스터에 장애가 발생했다고 판단되면, 레플리카 중 하나를 새로운 마스터로 자동으로 승격시켜 서비스 중단을 최소화합니다.

```
      +-----------+         +-----------+         +-----------+
      | Sentinel  |  <----->| Sentinel  |  <----->| Sentinel  |
      +-----------+         +-----------+         +-----------+
           |                      |                      |
           |   (마스터 감시 및      |    (장애 발생 시        |
           |    장애 조치 명령)      |     서로 투표)         |
           V                      V                      V
      +-----------+ <---(복제)--- +-----------+ <---(복제)--- +-----------+
      |  Master   |              |  Replica  |              |  Replica  |
      +-----------+              +-----------+              +-----------+
           ^                               |                      |
           |   (쓰기 작업)                 |    (읽기 작업)         |
           +-------------------------------+----------------------+
                                  |
                           +---------------+
                           |  Spring 서버  |
                           +---------------+
```

## 2. 마스터 (Master) 서버 설정

마스터 서버는 데이터의 안정성과 보안, 그리고 서버 전체의 안정성을 책임지는 가장 중요한 부분입니다.

**파일 경로**: `redis/master/redis.conf`

| 설정 | 값 | 이유 |
| :--- | :--- | :--- |
| `port` | `6379` | Redis의 표준 포트입니다. |
| `requirepass "..."` | (안전한 비밀번호) | **(보안)** 비밀번호를 설정하여 허가되지 않은 클라이언트의 접근을 막습니다. 가장 기본적인 보안 조치입니다. |
| `protected-mode yes` | `yes` | **(보안)** `requirepass`와 함께 사용하여, 비밀번호 인증 없이는 외부 IP에서의 접속을 원천 차단합니다. |
| `maxmemory 512mb` | `512mb` | **(안정성)** Redis가 사용할 최대 메모리를 512MB로 제한합니다. 이 설정이 없으면 Redis가 서버의 모든 메모리를 사용해버려, 결국 서버 전체가 다운되는(OOM: Out Of Memory) 재앙을 막을 수 있습니다. |
| `maxmemory-policy allkeys-lru` | `allkeys-lru` | **(안정성)** `maxmemory`에 도달했을 때 어떤 데이터를 삭제할지 정하는 정책입니다. `allkeys-lru`는 '가장 오랫동안 사용되지 않은' 데이터부터 삭제하여, 메모리 공간을 확보하는 가장 일반적이고 합리적인 방식입니다. |
| `appendonly yes` | `yes` | **(데이터 보존)** 모든 쓰기 명령을 파일(AOF)에 기록하여 데이터 내구성을 높입니다. Redis가 재시작되어도 데이터를 보존하기 위함입니다. |
| `appendfsync everysec` | `everysec` | **(데이터 보존)** AOF 파일을 디스크에 쓰는 주기입니다. `everysec`은 1초에 한 번씩 기록하여, 장애가 발생해도 최대 1초 분량의 데이터만 유실되도록 합니다. 성능과 안정성 사이의 가장 좋은 균형점입니다. |
| `save 60 1000` | `60 1000` | **(빠른 재시작)** 60초 동안 1000개 이상의 키가 변경되면, 메모리의 모든 데이터를 하나의 파일(RDB)로 저장합니다. AOF와 함께 사용하면, 재시작 시 RDB 파일을 먼저 읽어 속도를 높이고, 이후 AOF 로그를 적용하여 데이터 유실을 최소화하는 '하이브리드' 방식으로 동작합니다. |

## 3. 레플리카 (Replica) 서버 설정

레플리카는 마스터를 보조하고, 마스터의 장애 상황을 대비하는 역할을 합니다.

**파일 경로**: `redis/replica/redis.conf`

| 설정 | 값 | 이유 |
| :--- | :--- | :--- |
| `replicaof redis-master 6379` | `redis-master 6379`| 이 Redis 인스턴스가 `redis-master` 서버의 복제본(레플리카)임을 선언합니다. |
| `masterauth "..."` | (안전한 비밀번호) | **(보안)** 비밀번호가 설정된 마스터 서버에 접속하기 위해 필요합니다. |
| `requirepass "..."`| (안전한 비밀번호) | **(보안)** 레플리카 자체에도 비밀번호를 설정하여 직접적인 외부 접근을 통제합니다. |
| `appendonly no`<br>`save ""` | (비활성화) | **(성능 최적화)** 레플리카의 주 역할은 마스터 데이터를 복제하는 것이지, 디스크에 쓰는 것이 아닙니다. 따라서 레플리카에서는 데이터 기록 기능을 꺼서 디스크 I/O 부하를 줄이고, 마스터를 따라가는 복제 성능을 높입니다. (만약 이 레플리카가 마스터로 승격되면, Sentinel이 이 설정을 동적으로 변경해줍니다.) |

## 4. 센티널 (Sentinel) 설정

센티널은 Redis 클러스터의 '지휘관' 역할을 하며, 장애 감지와 자동 복구를 담당합니다.

**파일 경로**: `redis/sentinel/sentinel.conf`

| 설정 | 값 | 이유 |
| :--- | :--- | :--- |
| `port` | `26379` | Sentinel의 표준 포트입니다. |
| `sentinel monitor bm-master redis-master 6379 2` | `...` | **(핵심 기능)** "나는 `redis-master:6379` 서버를 `bm-master`라는 별명으로 감시하겠다. 그리고 마스터가 죽었다고 판단하려면, 나를 포함한 **최소 2대**의 Sentinel이 동의해야 한다." 라는 의미입니다. 마지막 숫자 `2`를 **쿼럼(Quorum, 정족수)**이라 부르며, 한 대의 Sentinel이 네트워크 문제 등으로 잘못 판단하여 장애 조치를 실행하는 것을 막아줍니다. |
| `sentinel auth-pass bm-master "..."` | `...` | **(보안)** 비밀번호가 설정된 `bm-master`를 감시하기 위해 Sentinel이 사용할 비밀번호입니다. |
| `sentinel down-after-milliseconds bm-master 5000` | `5000` | 마스터가 5000ms(5초) 동안 응답이 없으면 '죽었을 수도 있다'고 의심하기 시작합니다. |
| `sentinel failover-timeout bm-master 60000` | `60000` | 장애 조치(Failover)를 시작한 후, 60000ms(60초) 내에 모든 과정(레플리카를 마스터로 승격시키고 나머지 레플리카들이 새 마스터를 바라보게 하는 등)이 완료되어야 함을 의미합니다. |
| `sentinel parallel-syncs bm-master 1` | `1` | 새로운 마스터가 탄생했을 때, 여러 레플리카들이 한꺼번에 새 마스터의 데이터를 복제하려고 몰리면 과부하가 걸릴 수 있습니다. 이를 방지하기 위해 한 번에 한 대의 레플리카만 전체 데이터 동기화를 하도록 제한합니다. |

---

이 가이드가 Redis 구성을 이해하는 데 도움이 되길 바랍니다. 궁금한 점이 있다면 언제든지 질문해주세요.
