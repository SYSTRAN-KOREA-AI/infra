name: Infra Deployment

on:
  workflow_dispatch:
    inputs:
      server:
        description: "서버 선택 (27=dev, 26=stage, 195=prod)"
        required: true
        type: choice
        options: ["27", "26", "195"]

      deploy_redis:
        description: "Redis 배포 여부"
        required: true
        type: boolean
        default: false

      deploy_rabbitmq:
        description: "RabbitMQ 배포 여부"
        required: true
        type: boolean
        default: false

env:
  SERVER_HOST: ${{ (inputs.server == '195' && secrets.SERVER_195_HOST) || (inputs.server == '26' && secrets.SERVER_26_HOST) || secrets.SERVER_27_HOST }}
  SERVER_PORT: ${{ (inputs.server == '195' && secrets.SERVER_195_PORT) || (inputs.server == '26' && secrets.SERVER_26_PORT) || secrets.SERVER_27_PORT }}
  SERVER_USER: ${{ (inputs.server == '195' && secrets.SERVER_195_USER) || (inputs.server == '26' && secrets.SERVER_26_USER) || secrets.SERVER_27_USER }}
  BASE64_KEY: ${{ (inputs.server == '195' && secrets.SERVER_195_KEY) || (inputs.server == '26' && secrets.SERVER_26_KEY) || secrets.SERVER_27_KEY }}
  INFRA_DIR: ${{ vars.INFRA_BASE_PATH }}

jobs:
  deploy-rabbitmq:
    if: ${{ inputs.deploy_rabbitmq == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 프라이빗 키 준비
      - name: Prepare SSH key
        run: |
          echo "${{ env.BASE64_KEY }}" | base64 --decode > private_key
          chmod 600 private_key

      - name: Deploy infra (RabbitMQ)
        run: |
          HOST="${{ env.SERVER_HOST }}"
          PORT="${{ env.SERVER_PORT }}"
          USER="${{ env.SERVER_USER }}"
          INFRA="${{ env.INFRA_DIR }}"
          
          ssh -o StrictHostKeyChecking=no -i private_key -p "$PORT" "$USER@$HOST" '
              set -e
          
              echo "[INFO] INFRA_DIR='$INFRA'"
          
              echo "[DEPLOY] Update infra repo"
              if [ ! -d "'$INFRA'/.git" ]; then
                rm -rf '$INFRA'
                git clone https://github.com/SYSTRAN-KOREA-AI/infra.git "'$INFRA'"
              fi
          
              cd "'$INFRA'" || { echo "Failed to cd into $INFRA"; exit 1; }
              git fetch origin main
              git reset --hard origin/main 
              git clean -fd

              echo "[DEPLOY] Apply RabbitMQ compose"
              cd rabbitmq
              docker compose up -d --build

              echo "[CLEANUP] remove unused images"
              docker image prune -f || true
              '

  deploy-redis:
    if: ${{ inputs.deploy_redis == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 프라이빗 키 준비
      - name: Prepare SSH key
        run: |
          echo "${{ env.BASE64_KEY }}" | base64 --decode > private_key
          chmod 600 private_key

      - name: Deploy infra (Redis)
        run: |
          HOST="${{ env.SERVER_HOST }}"
          PORT="${{ env.SERVER_PORT }}"
          USER="${{ env.SERVER_USER }}"
          INFRA="${{ env.INFRA_DIR }}"
          
          ssh -o StrictHostKeyChecking=no -i private_key -p "$PORT" "$USER@$HOST" '
              set -e
          
              echo "[INFO] INFRA_DIR='$INFRA'"
          
              if [ ! -d "'$INFRA'/.git" ]; then
                rm -rf '$INFRA'
                git clone https://github.com/SYSTRAN-KOREA-AI/infra.git "'$INFRA'"
              fi
          
              cd "'$INFRA'" || { echo "Failed to cd into $INFRA"; exit 1; }
              git fetch origin main
              git reset --hard origin/main 
              git clean -fd

              echo "[DEPLOY] Apply Redis compose"
              cd redis
              docker compose up -d --build

              echo "[CLEANUP] remove unused images"
              docker image prune -f || true
              '