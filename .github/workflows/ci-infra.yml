name: Infra Deployment

on:
  workflow_dispatch:
    inputs:
      server:
        description: "서버 선택 (27=dev, 26=stage, 195=prod)"
        required: true
        type: choice
        options: ["27", "26", "195"]

      deploy_redis:
        description: "Redis 배포 여부"
        required: true
        type: boolean
        default: false

      deploy_rabbitmq:
        description: "RabbitMQ 배포 여부"
        required: true
        type: boolean
        default: false

env:
  SERVER_HOST: ${{ (inputs.server == '195' && secrets.SERVER_195_HOST) || (inputs.server == '26' && secrets.SERVER_26_HOST) || secrets.SERVER_27_HOST }}
  SERVER_PORT: ${{ (inputs.server == '195' && secrets.SERVER_195_PORT) || (inputs.server == '26' && secrets.SERVER_26_PORT) || secrets.SERVER_27_PORT }}
  SERVER_USER: ${{ (inputs.server == '195' && secrets.SERVER_195_USER) || (inputs.server == '26' && secrets.SERVER_26_USER) || secrets.SERVER_27_USER }}
  BASE64_KEY: ${{ (inputs.server == '195' && secrets.SERVER_195_KEY) || (inputs.server == '26' && secrets.SERVER_26_KEY) || secrets.SERVER_27_KEY }}
  PROFILE: ${{ (inputs.server == '27' && 'dev') || (inputs.server == '26' && 'stage') || (inputs.server == '195' && 'prod') }}
  INFRA_DIR: ${{ vars.INFRA_BASE_PATH }}

jobs:
  deploy-rabbitmq:
    if: ${{ inputs.deploy_rabbitmq == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 프라이빗 키 준비
      - name: Prepare SSH key
        run: |
          echo "${{ env.BASE64_KEY }}" | base64 --decode > private_key
          chmod 600 private_key

      - name: Deploy infra (RabbitMQ)
        run: |
          HOST="${{ env.SERVER_HOST }}"
          PORT="${{ env.SERVER_PORT }}"
          USER="${{ env.SERVER_USER }}"
          INFRA="${{ env.INFRA_DIR }}"
          PROFILE="${{ env.PROFILE }}"
          ENV_DEV="${{ secrets.ENV_DEV }}"
          ENV_STAGE="${{ secrets.ENV_STAGE }}"
          ENV_PROD="${{ secrets.ENV_PROD }}"
          
          ssh -o StrictHostKeyChecking=no -i private_key -p "$PORT" "$USER@$HOST" '
              set -e
          
              echo "[INFO] INFRA_DIR='$INFRA'"
          
              echo "[DEPLOY] Update infra repo"
              if [ ! -d "'$INFRA'/.git" ]; then
                rm -rf '$INFRA'
                git clone https://github.com/SYSTRAN-KOREA-AI/infra.git "'$INFRA'"
                cd "'$INFRA'" || { echo "Failed to cd into $INFRA"; exit 1; }
              else
                echo "[DEPLOY] Sync infra repo with origin/main using robust fetch/reset"
                cd "'$INFRA'" || { echo "Failed to cd into $INFRA"; exit 1; }
                git remote prune origin
                git fetch --all
                git reset --hard origin/main 
                git clean -fd
              fi
              
              echo "[DEPLOY] Creating .env files based on profile: '$PROFILE'"
              echo "'$ENV_DEV'" > "'$INFRA'/.env.dev"
              echo "'$ENV_STAGE'" > "'$INFRA'/.env.stage"
              echo "'$ENV_PROD'" > "'$INFRA'/.env.prod"

              echo "[DEPLOY] Apply RabbitMQ compose"
              cd rabbitmq
              "docker compose --env-file ../.env.'$PROFILE' up -d --build"

              echo "[CLEANUP] remove unused images"
              docker image prune -f || true
              '

  deploy-redis:
    if: ${{ inputs.deploy_redis == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 프라이빗 키 준비
      - name: Prepare SSH key
        run: |
          echo "${{ env.BASE64_KEY }}" | base64 --decode > private_key
          chmod 600 private_key

      - name: Deploy infra (Redis)
        run: |
          HOST="${{ env.SERVER_HOST }}"
          PORT="${{ env.SERVER_PORT }}"
          USER="${{ env.SERVER_USER }}"
          INFRA="${{ env.INFRA_DIR }}"
          PROFILE="${{ env.PROFILE }}"
          ENV_DEV="${{ secrets.ENV_DEV }}"
          ENV_STAGE="${{ secrets.ENV_STAGE }}"
          ENV_PROD="${{ secrets.ENV_PROD }}"

          ssh -o StrictHostKeyChecking=no -i private_key -p "$PORT" "$USER@$HOST" '
              set -e

              echo "[INFO] INFRA_DIR='$INFRA'"

              echo "[DEPLOY] Update infra repo"
              if [ ! -d "'$INFRA'/.git" ]; then
                rm -rf '$INFRA'
                git clone https://github.com/SYSTRAN-KOREA-AI/infra.git "'$INFRA'"
                cd "'$INFRA'" || { echo "Failed to cd into $INFRA"; exit 1; }
              else
                echo "[DEPLOY] Sync infra repo with origin/main using robust fetch/reset"
                cd "'$INFRA'" || { echo "Failed to cd into $INFRA"; exit 1; }
                git remote prune origin
                git fetch --all
                git reset --hard origin/main 
                git clean -fd
              fi

              echo "[DEPLOY] Creating .env files based on profile: '$PROFILE'"
              echo "'$ENV_DEV'" > "'$INFRA'/.env.dev"
              echo "'$ENV_STAGE'" > "'$INFRA'/.env.stage"
              echo "'$ENV_PROD'" > "'$INFRA'/.env.prod"

              echo "[DEPLOY] Apply Redis compose"
              cd redis
              "docker compose --env-file ../.env.'$PROFILE' up -d --build"

              echo "[CLEANUP] remove unused images"
              docker image prune -f || true
              '