name: Infra Deployment

on:
  workflow_dispatch:
    inputs:
      server:
        description: "서버 선택 (27=dev, 26=stage, 195=prod)"
        required: true
        type: choice
        options: ["27", "26", "195"]

      deploy_redis:
        description: "Redis 배포 여부"
        required: true
        type: boolean
        default: false

      deploy_rabbitmq:
        description: "RabbitMQ 배포 여부"
        required: true
        type: boolean
        default: false

env:
  PREFIX_HOST: ${{
    (github.event.inputs.server == '195' && secrets.SERVER_195_HOST) ||
    (github.event.inputs.server == '26'  && secrets.SERVER_26_HOST)  ||
    secrets.SERVER_27_HOST
  }}
  PREFIX_PORT: ${{
    (github.event.inputs.server == '195' && secrets.SERVER_195_PORT) ||
    (github.event.inputs.server == '26'  && secrets.SERVER_26_PORT)  ||
    secrets.SERVER_27_PORT
  }}
  PREFIX_USER: ${{
    (github.event.inputs.server == '195' && secrets.SERVER_195_USER) ||
    (github.event.inputs.server == '26'  && secrets.SERVER_26_USER)  ||
    secrets.SERVER_27_USER
  }}
  BASE64_KEY: ${{
    (github.event.inputs.server == '195' && secrets.SERVER_195_KEY) ||
    (github.event.inputs.server == '26'  && secrets.SERVER_26_KEY)  ||
    secrets.SERVER_27_KEY
  }}
  INFRA_DIR: ${{ vars.INFRA_BASE_PATH }}

jobs:
  deploy-rabbitmq:
    if: ${{ github.event.inputs.deploy_rabbitmq == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # prefix 제거
      - name: Normalize host
        id: host
        run: |
          RAW="${{ env.PREFIX_HOST }}"
          HOST="${RAW#systran-}"
          echo "host=$HOST" >> "$GITHUB_OUTPUT"

      - name: Normalize port
        id: port
        run: |
          RAW="${{ env.PREFIX_PORT }}"
          PORT="${RAW#systran-}"
          echo "port=$PORT" >> "$GITHUB_OUTPUT"

      - name: Normalize user
        id: user
        run: |
          RAW="${{ env.PREFIX_USER }}"
          USER="${RAW#systran-}"
          echo "user=$USER" >> "$GITHUB_OUTPUT"

      # 프라이빗 키 준비
      - name: Prepare SSH key
        run: |
          echo "${{ env.BASE64_KEY }}" | base64 --decode > private_key
          chmod 600 private_key

      - name: Deploy infra (RabbitMQ)
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key -p "${{ steps.port.outputs.port }}" \
            "${{ steps.user.outputs.user }}@${{ steps.host.outputs.host }}" '
              set -e
          
              echo "[INFO] Using INFRA_DIR: ${{ env.INFRA_DIR }}"
          
              echo "[DEPLOY] Update infra repo"
              if [ ! -d "${{ env.INFRA_DIR }}/.git" ]; then
                git clone https://github.com/SYSTRAN-KOREA-AI/infra.git "${{ env.INFRA_DIR }}"
              else
                cd "${{ env.INFRA_DIR }}" && git pull origin main
              fi

              echo "[DEPLOY] Apply RabbitMQ compose"
              cd "${{ env.INFRA_DIR }}"/rabbitmq
              docker compose up -d --build

              echo "[CLEANUP] remove unused images"
              docker image prune -f || true
              '

  deploy-redis:
    if: ${{ github.event.inputs.deploy_redis == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # prefix 제거
      - name: Normalize host
        id: host
        run: |
          RAW="${{ env.PREFIX_HOST }}"
          HOST="${RAW#systran-}"
          echo "host=$HOST" >> "$GITHUB_OUTPUT"

      - name: Normalize port
        id: port
        run: |
          RAW="${{ env.PREFIX_PORT }}"
          PORT="${RAW#systran-}"
          echo "port=$PORT" >> "$GITHUB_OUTPUT"

      - name: Normalize user
        id: user
        run: |
          RAW="${{ env.PREFIX_USER }}"
          USER="${RAW#systran-}"
          echo "user=$USER" >> "$GITHUB_OUTPUT"

      # 프라이빗 키 준비
      - name: Prepare SSH key
        run: |
          echo "${{ env.BASE64_KEY }}" | base64 --decode > private_key
          chmod 600 private_key

      - name: Deploy infra (Redis)
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key -p "${{ steps.port.outputs.port }}" \
            "${{ steps.user.outputs.user }}@${{ steps.host.outputs.host }}" '
              set -e

              echo "[INFO] Using INFRA_DIR: ${{ env.INFRA_DIR }}"

              echo "[DEPLOY] Update infra repo"
              if [ ! -d "${{ env.INFRA_DIR }}/.git" ]; then
                git clone https://github.com/SYSTRAN-KOREA-AI/infra.git "${{ env.INFRA_DIR }}"
              else
                cd "${{ env.INFRA_DIR }}" && git pull origin main
              fi

              echo "[DEPLOY] Apply Redis compose"
              cd "${{ env.INFRA_DIR }}"/redis
              docker compose up -d --build

              echo "[CLEANUP] remove unused images"
              docker image prune -f || true
              '