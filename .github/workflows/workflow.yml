name: Infra Deployment

on:
  workflow_dispatch:
    inputs:
      server:
        description: "서버 선택 (27=dev, 26=stage, 195=prod)"
        required: true
        type: choice
        options: ["27", "26", "195"]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      rabbitmq: ${{ steps.filter.outputs.rabbitmq }}
      redis: ${{ steps.filter.outputs.redis }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rabbitmq:
              - 'infra/rabbitmq/**'
            
            redis:
              - 'infra/redis/**'

  deploy-rabbitmq:
    needs: detect-changes
    if: needs.detect-changes.outputs.rabbitmq == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # prefix 제거
      - name: Normalize host
        id: host
        run: |
          RAW="${{ secrets.PREFIX_HOST }}"
          HOST="${RAW#systran-}"
          echo "host=$HOST" >> "$GITHUB_OUTPUT"

      - name: Normalize port
        id: port
        run: |
          RAW="${{ secrets.PREFIX_PORT }}"
          PORT="${RAW#systran-}"
          echo "port=$PORT" >> "$GITHUB_OUTPUT"

      - name: Normalize user
        id: user
        run: |
          RAW="${{ secrets.PREFIX_USER }}"
          USER="${RAW#systran-}"
          echo "user=$USER" >> "$GITHUB_OUTPUT"

      # 프라이빗 키 준비
      - name: Prepare SSH key
        run: |
          echo "${{ secrets.BASE64_KEY }}" | base64 --decode > private_key
          chmod 600 private_key

      - name: Deploy infra (RabbitMQ)
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key -p "${{ steps.port.outputs.port }}" \
            "${{ steps.user.outputs.user }}@${{ steps.host.outputs.host }}" '
              set -e

              echo "[DEPLOY] Update infra repo"
              if [ ! -d "/opt/business_meeting/infra/.git" ]; then
                git clone https://github.com/YOUR_ORG/YOUR_INFRA_REPO.git /opt/business_meeting/infra
              else
                git -C /opt/business_meeting/infra pull origin main
              fi

              echo "[DEPLOY] Apply RabbitMQ compose"
              cd /opt/business_meeting/infra/rabbitmq
              docker compose up -d --build

              echo "[CLEANUP] remove unused images"
              docker image prune -f || true
              '

  deploy-redis:
    needs: detect-changes
    if: needs.detect-changes.outputs.redis == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # prefix 제거
      - name: Normalize host
        id: host
        run: |
          RAW="${{ secrets.PREFIX_HOST }}"
          HOST="${RAW#systran-}"
          echo "host=$HOST" >> "$GITHUB_OUTPUT"

      - name: Normalize port
        id: port
        run: |
          RAW="${{ secrets.PREFIX_PORT }}"
          PORT="${RAW#systran-}"
          echo "port=$PORT" >> "$GITHUB_OUTPUT"

      - name: Normalize user
        id: user
        run: |
          RAW="${{ secrets.PREFIX_USER }}"
          USER="${RAW#systran-}"
          echo "user=$USER" >> "$GITHUB_OUTPUT"

      # 프라이빗 키 준비
      - name: Prepare SSH key
        run: |
          echo "${{ secrets.BASE64_KEY }}" | base64 --decode > private_key
          chmod 600 private_key

      - name: Deploy infra (Redis)
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key -p "${{ steps.port.outputs.port }}" \
            "${{ steps.user.outputs.user }}@${{ steps.host.outputs.host }}" '
              set -e

              echo "[DEPLOY] Update infra repo"
              if [ ! -d "/opt/business_meeting/infra/.git" ]; then
                git clone https://github.com/YOUR_ORG/YOUR_INFRA_REPO.git /opt/business_meeting/infra
              else
                git -C /opt/business_meeting/infra pull origin main
              fi

              echo "[DEPLOY] Apply Redis compose"
              cd /opt/business_meeting/infra/redis
              docker compose up -d --build

              echo "[CLEANUP] remove unused images"
              docker image prune -f || true
              '