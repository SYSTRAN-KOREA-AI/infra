# RabbitMQ 정책(Policies) 설정 가이드

이 문서는 우리 프로젝트의 RabbitMQ가 어떻게 설정되어 있는지, 그리고 왜 그렇게 설정되었는지 설명하기 위한 가이드입니다. RabbitMQ의 정책(Policy)은 큐(Queue)의 동작 방식을 제어하는 매우 강력하고 유연한 기능입니다.

현재 우리 시스템은 `rabbitmq/definitions.json` 파일에 정의된 정책들을 통해 다음 두 가지 핵심 목표를 달성하고 있습니다.

1.  **자원 관리**: 사용하지 않는 임시 큐를 자동으로 정리하여 서버의 안정성을 유지합니다.
2.  **고가용성 및 데이터 안정성**: 중요한 비즈니스 데이터가 담긴 큐를 여러 서버에 복제하여, 서버 장애 시에도 데이터가 유실되지 않도록 보호합니다.

---

## 설정된 정책 상세 설명

현재 두 가지 정책이 활성화되어 있습니다.

### 1. `user-queues-auto-expire` 정책: 임시 큐 자동 삭제

이 정책은 시스템에 불필요한 쓰레기 데이터가 쌓이는 것을 막는 **'청소부'** 역할을 합니다.

| 설정 | 값 | 설명 |
| :--- | :--- | :--- |
| **`name`** | `user-queues-auto-expire` | 정책의 이름입니다. (사람이 식별하기 위함) |
| **`pattern`** | `^translations-user.*` | 이 정책이 적용될 대상을 지정합니다. `translations-user`로 시작하는 모든 큐에 이 정책이 적용됩니다. |
| **`definition`** | `{ "expires": 3600000 }` | 정책의 핵심 내용입니다. 큐가 3,600,000ms (1시간) 동안 사용되지 않으면 (예: 연결된 Consumer가 없고, 새로운 메시지도 없는 상태) RabbitMQ가 해당 큐를 **자동으로 삭제**합니다. |
| **`priority`** | `0` | 정책의 우선순위입니다. 숫자가 높을수록 우선순위가 높습니다. (0은 낮은 편) |

#### 왜 이 정책을 사용하나요?

-   `translations-user` 큐는 아마도 각 사용자를 위한 임시적인 큐일 가능성이 높습니다.
-   사용자가 접속을 종료한 후에도 이 큐들이 계속 남아있으면, 수천, 수만 개의 좀비 큐가 서버의 메모리와 리소스를 낭비하게 됩니다.
-   이 정책은 더 이상 사용되지 않는 큐들을 자동으로 정리하여 RabbitMQ 서버가 항상 최적의 상태를 유지하도록 돕습니다.

---

### 2. `bm-quorum-queues` 정책: 고가용성 복제 큐

이 정책은 절대로 유실되면 안 되는 중요한 데이터를 보호하는 **'안전장치'** 역할을 합니다.

| 설정 | 값 | 설명 |
| :--- | :--- | :--- |
| **`name`** | `bm-quorum-queues` | 정책의 이름입니다. |
| **`pattern`** | `^bm\.` | **`bm.`**으로 시작하는 모든 큐에 이 정책이 적용됩니다. (예: `bm.orders`, `bm.payments`) |
| **`definition`** | `{ ... }` | 아래 두 가지 중요한 규칙을 적용합니다. |
| | **`"x-queue-type": "quorum"`** | 이 한 줄이 해당 큐를 **Quorum Queue**로 만듭니다. Quorum Queue는 RabbitMQ의 최신 고가용성 기능으로, 큐의 데이터가 클러스터를 구성하는 여러 서버에 **자동으로 복제**됩니다. <br> - **효과 1 (데이터 보존)**: 한 서버가 다운되어도 다른 서버에 데이터가 남아있어 유실되지 않습니다. <br> - **효과 2 (자동 Failover)**: 큐의 리더 역할을 하던 서버가 다운되면, 다른 서버가 즉시 새로운 리더가 되어 서비스 중단을 최소화합니다. |
| | **`"x-delivery-limit": 3`** | **포이즌 메시지(Poison Message) 처리** 기능입니다. 만약 어떤 메시지에 문제가 있어 Consumer가 계속 처리 실패를 일으킨다면, 해당 메시지의 재시도 횟수를 3번으로 제한합니다. 3번 실패 시, 해당 메시지는 자동으로 폐기되거나 다른 곳(DLX)으로 보내져, 문제 있는 메시지 하나 때문에 전체 큐가 마비되는 것을 방지합니다. |
| **`priority`** | `10` | 다른 정책보다 높은 우선순위를 부여하여, `bm.`으로 시작하는 큐에는 이 정책이 확실하게 적용되도록 보장합니다. |

#### 왜 이 정책을 사용하나요?

-   **선택적 고가용성 (Opt-in HA)**: 모든 큐를 복제하는 것은 자원 낭비입니다. 이 정책은 개발자가 `bm.`이라는 접두사를 붙인 **중요한 큐만 선택적으로 복제**하도록 유도합니다. 예를 들어, 주문, 결제, 회원가입 등 비즈니스적으로 매우 중요한 데이터는 `bm.orders` 와 같이 명명하여 데이터의 안정성을 보장받을 수 있습니다.
-   **시스템 안정성**: 포이즌 메시지 방지 기능을 통해, 예기치 않은 버그나 잘못된 데이터가 전체 시스템에 장애를 전파하는 것을 막아줍니다.

이 두 가지 정책을 통해, 우리 시스템은 리소스를 효율적으로 사용하면서도, 중요한 데이터는 서버 장애 상황에서도 안전하게 보호할 수 있는 견고한 메시징 아키텍처를 갖추게 됩니다.
